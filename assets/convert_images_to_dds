#!/usr/bin/env bash
set -euo pipefail

# Converts images under assets/images/ into BC7-compressed DDS files under assets/textures/.
#
# Requires: `compressonator` in PATH (Compressonator CLI wrapper).
# - Arch AUR: https://aur.archlinux.org/packages/compressonator-git
#
# Usage:
#   ./convert_images_to_dds [--force] [--threads N] [<input_dir>] [<output_dir>]
#
# Defaults:
#   input_dir  = ./assets/images
#   output_dir = ./assets/textures

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." >/dev/null 2>&1 && pwd)"

force=0
threads="$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo 1)"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --force)
      force=1
      shift
      ;;
    --threads)
      threads="${2:-}"
      shift 2
      ;;
    -h|--help)
      sed -n '1,120p' "$0"
      exit 0
      ;;
    *)
      break
      ;;
  esac
done

input_dir="${1:-$REPO_ROOT/assets/images}"
output_dir="${2:-$REPO_ROOT/assets/textures}"

if ! command -v compressonator >/dev/null 2>&1; then
  echo "error: compressonator not found." >&2
  echo "Install it on Arch via AUR:" >&2
  echo "  git clone https://aur.archlinux.org/compressonator-git.git" >&2
  echo "  cd compressonator-git" >&2
  echo "  makepkg -si" >&2
  exit 1
fi

if [[ -z "$threads" ]] || ! [[ "$threads" =~ ^[0-9]+$ ]] || [[ "$threads" -lt 1 ]]; then
  echo "error: --threads must be a positive integer" >&2
  exit 1
fi

mkdir -p "$output_dir"

shopt -s nullglob

# Find common image types. (We keep this simple: top-level + recursive under input_dir)
mapfile -t sources < <(
  find "$input_dir" \
    -type f \
    \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.tga' -o -iname '*.bmp' \) \
    ! -path "$output_dir/*" \
    -print
)

if [[ ${#sources[@]} -eq 0 ]]; then
  echo "no images found under: $input_dir"
  exit 0
fi

converted=0
skipped=0

for src in "${sources[@]}"; do
  rel="${src#$input_dir/}"
  stem_rel="${rel%.*}"
  dst="$output_dir/$stem_rel.dds"

  mkdir -p "$(dirname -- "$dst")"

  if [[ $force -eq 0 && -f "$dst" && "$dst" -nt "$src" ]]; then
    echo "skip: $src -> $(basename -- "$dst") (up to date)"
    skipped=$((skipped + 1))
    continue
  fi

  echo "convert: $src -> $dst"
  compressonator -fd BC7 -NumThreads "$threads" "$src" "$dst"
  converted=$((converted + 1))
done

echo "done. converted=$converted skipped=$skipped out=$output_dir"
