#!/usr/bin/env bash
set -euo pipefail

# Compile all GLSL shaders in this folder into ./spv using glslc.
#
# Assumptions:
# - Run from anywhere; script locates its own directory.
# - Shader stage is inferred from file extension: .vert/.frag
# - Vulkan environment is requested so we can use Vulkan GLSL features.

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/../.." >/dev/null 2>&1 && pwd)"
OUT_DIR="$REPO_ROOT/assets/spv"

mkdir -p "$OUT_DIR"

if ! command -v glslc >/dev/null 2>&1; then
  echo "error: glslc not found. Install shaderc / Vulkan SDK (glslc)." >&2
  exit 1
fi

compile_one() {
  local src="$1"
  local base
  base="$(basename -- "$src")"

  case "$src" in
    *.vert)
      glslc --target-env=vulkan1.2 -fshader-stage=vert "$src" -o "$OUT_DIR/$base.spv"
      ;;
    *.frag)
      glslc --target-env=vulkan1.2 -fshader-stage=frag "$src" -o "$OUT_DIR/$base.spv"
      ;;
    *)
      return 0
      ;;
  esac
}

shopt -s nullglob

# Compile shaders in this directory.
for f in "$SCRIPT_DIR"/*.vert "$SCRIPT_DIR"/*.frag; do
  compile_one "$f"
  echo "compiled: $(basename -- "$f") -> spv/$(basename -- "$f").spv"
done

# Compile shaders in immediate subdirectories too (you currently have vertex/ + fragment/).
for d in "$SCRIPT_DIR"/*/; do
  [[ -d "$d" ]] || continue
  for f in "$d"*.vert "$d"*.frag; do
    [[ -f "$f" ]] || continue
    compile_one "$f"
    echo "compiled: ${f#$SCRIPT_DIR/} -> spv/$(basename -- "$f").spv"
  done
done

echo "done. output in: $OUT_DIR"
